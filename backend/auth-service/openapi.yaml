openapi: 3.0.3
info:
  title: ProtobankBankC Auth Service API
  description: |
    Authentication and authorization service for ProtobankBankC banking application.

    ## Features
    - User registration with KYC validation
    - JWT-based authentication
    - Token refresh mechanism
    - Rate limiting (10 requests/minute per IP)
    - Comprehensive security controls

    ## Authentication
    Most endpoints require a Bearer token in the Authorization header:
    ```
    Authorization: Bearer <access_token>
    ```
  version: 1.0.0
  contact:
    name: ProtobankBankC Team
    email: support@protobankbankc.com
  license:
    name: Proprietary

servers:
  - url: http://localhost:8080
    description: Local development
  - url: https://api-dev.protobankbankc.com
    description: Development environment
  - url: https://api.protobankbankc.com
    description: Production environment

tags:
  - name: Authentication
    description: User authentication endpoints
  - name: Health
    description: Service health and monitoring
  - name: Metrics
    description: Prometheus metrics

paths:
  /api/v1/auth/register:
    post:
      tags:
        - Authentication
      summary: Register a new user
      description: |
        Creates a new user account with KYC information.

        **Requirements:**
        - User must be 18 years or older
        - Password must meet strength requirements
        - Email must be unique
      operationId: register
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
            example:
              email: john.doe@example.com
              phone: "+447700900123"
              password: "SecurePass123!"
              first_name: John
              last_name: Doe
              date_of_birth: "1990-01-01T00:00:00Z"
              address_line1: "123 Main Street"
              address_line2: "Apt 4B"
              city: London
              region: "Greater London"
              postcode: "SW1A 1AA"
              country: UK
      responses:
        '201':
          description: User registered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: user registered successfully
                  user:
                    $ref: '#/components/schemas/User'
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          $ref: '#/components/responses/Conflict'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/v1/auth/login:
    post:
      tags:
        - Authentication
      summary: Login user
      description: Authenticate user and receive access and refresh tokens
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
            example:
              email: john.doe@example.com
              password: "SecurePass123!"
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/v1/auth/refresh:
    post:
      tags:
        - Authentication
      summary: Refresh access token
      description: Get a new access token using a valid refresh token
      operationId: refreshToken
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshTokenRequest'
            example:
              refresh_token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
      responses:
        '200':
          description: Token refreshed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RefreshTokenResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/v1/auth/me:
    get:
      tags:
        - Authentication
      summary: Get current user
      description: Retrieve information about the authenticated user
      operationId: getCurrentUser
      security:
        - BearerAuth: []
      responses:
        '200':
          description: User information retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/v1/auth/logout:
    post:
      tags:
        - Authentication
      summary: Logout user
      description: |
        Logout the user. For JWT-based auth, this is primarily a client-side operation.
        Future implementations may include token blacklisting.
      operationId: logout
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Logout successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: logout successful
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: Check service health status
      operationId: healthCheck
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /ready:
    get:
      tags:
        - Health
      summary: Readiness check
      description: Check if service is ready to accept traffic (Kubernetes readiness probe)
      operationId: readinessCheck
      responses:
        '200':
          description: Service is ready
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ready

  /live:
    get:
      tags:
        - Health
      summary: Liveness check
      description: Check if service is alive (Kubernetes liveness probe)
      operationId: livenessCheck
      responses:
        '200':
          description: Service is alive
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: alive

  /metrics:
    get:
      tags:
        - Metrics
      summary: Prometheus metrics
      description: Expose Prometheus metrics for monitoring
      operationId: getMetrics
      responses:
        '200':
          description: Prometheus metrics
          content:
            text/plain:
              schema:
                type: string

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT access token

  schemas:
    RegisterRequest:
      type: object
      required:
        - email
        - phone
        - password
        - first_name
        - last_name
        - date_of_birth
        - address_line1
        - city
        - postcode
        - country
      properties:
        email:
          type: string
          format: email
          description: User email address
          example: john.doe@example.com
        phone:
          type: string
          description: Phone number in E.164 format
          example: "+447700900123"
        password:
          type: string
          format: password
          minLength: 8
          description: |
            Password must contain:
            - At least 8 characters
            - One uppercase letter
            - One lowercase letter
            - One number
            - One special character
          example: "SecurePass123!"
        first_name:
          type: string
          description: User's first name
          example: John
        last_name:
          type: string
          description: User's last name
          example: Doe
        date_of_birth:
          type: string
          format: date-time
          description: Date of birth (must be 18+)
          example: "1990-01-01T00:00:00Z"
        address_line1:
          type: string
          description: Primary address line
          example: "123 Main Street"
        address_line2:
          type: string
          description: Secondary address line (optional)
          example: "Apt 4B"
        city:
          type: string
          description: City
          example: London
        region:
          type: string
          description: State/Province/Region
          example: "Greater London"
        postcode:
          type: string
          description: Postal/ZIP code
          example: "SW1A 1AA"
        country:
          type: string
          description: Country code (ISO 3166-1 alpha-2)
          example: UK

    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          example: john.doe@example.com
        password:
          type: string
          format: password
          example: "SecurePass123!"
        device_id:
          type: string
          description: Optional device identifier
        device_type:
          type: string
          description: Optional device type (ios, android, web)

    LoginResponse:
      type: object
      properties:
        access_token:
          type: string
          description: JWT access token (15 minutes validity)
          example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
        refresh_token:
          type: string
          description: JWT refresh token (7 days validity)
          example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
        token_type:
          type: string
          enum: [Bearer]
          example: Bearer
        expires_in:
          type: integer
          description: Access token expiry in seconds
          example: 900
        user:
          $ref: '#/components/schemas/User'

    RefreshTokenRequest:
      type: object
      required:
        - refresh_token
      properties:
        refresh_token:
          type: string
          description: Valid refresh token
          example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."

    RefreshTokenResponse:
      type: object
      properties:
        access_token:
          type: string
          description: New JWT access token
          example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
        token_type:
          type: string
          enum: [Bearer]
          example: Bearer
        expires_in:
          type: integer
          description: Access token expiry in seconds
          example: 900

    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "123e4567-e89b-12d3-a456-426614174000"
        email:
          type: string
          format: email
          example: john.doe@example.com
        phone:
          type: string
          example: "+447700900123"
        first_name:
          type: string
          example: John
        last_name:
          type: string
          example: Doe
        date_of_birth:
          type: string
          format: date-time
          example: "1990-01-01T00:00:00Z"
        address_line1:
          type: string
          example: "123 Main Street"
        address_line2:
          type: string
          example: "Apt 4B"
        city:
          type: string
          example: London
        region:
          type: string
          example: "Greater London"
        postcode:
          type: string
          example: "SW1A 1AA"
        country:
          type: string
          example: UK
        kyc_status:
          type: string
          enum: [pending, verified, rejected]
          example: pending
        kyc_verified_at:
          type: string
          format: date-time
          nullable: true
        is_active:
          type: boolean
          example: true
        created_at:
          type: string
          format: date-time
          example: "2026-02-02T10:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2026-02-02T10:00:00Z"

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, unhealthy]
          example: healthy
        service:
          type: string
          example: auth-service
        version:
          type: string
          example: "1.0.0"
        uptime:
          type: string
          example: "1h23m45s"
        timestamp:
          type: string
          format: date-time
          example: "2026-02-02T10:00:00Z"

    Error:
      type: object
      properties:
        error:
          type: string
          description: Error message
          example: "invalid request body"

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "invalid request body: email is required"

    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "invalid email or password"

    Forbidden:
      description: Forbidden
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "account is inactive"

    Conflict:
      description: Resource already exists
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "user with this email already exists"

    TooManyRequests:
      description: Rate limit exceeded
      headers:
        X-RateLimit-Limit:
          schema:
            type: integer
          description: Rate limit ceiling for requests
        X-RateLimit-Remaining:
          schema:
            type: integer
          description: Number of requests left in current window
        X-RateLimit-Reset:
          schema:
            type: integer
          description: Unix timestamp when rate limit resets
        Retry-After:
          schema:
            type: integer
          description: Seconds until rate limit reset
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "rate limit exceeded"
            message: "Too many requests. Please try again in 45 seconds."

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "an unexpected error occurred"
